import { createHash } from "node:crypto";

export const NUM_HASHES = 128;

const SEEDS_A = new Uint32Array([
  80226839, 2372131257, 2830697387, 972336237, 3815558271, 2435870817, 3182221459, 439327125, 2421013479,
  1048042505, 1900235387, 2083531709, 133470287, 3247750321, 2630875491, 3853189861, 2015297975, 1916121689,
  3826943307, 854114061, 1715378207, 1037917441, 64917043, 1766195253, 2784557959, 1650613417, 4031493147,
  3652413021, 531090415, 2020561233, 3280312067, 2469761413, 1725475159, 3456293625, 2082723563, 627384749,
  550319039, 284137889, 2343703507, 3001988821, 989530919, 1230777673, 892333499, 1410527485, 4052471695,
  608384497, 3146843299, 3374739493, 2782732535, 2381534105, 1614608523, 2098320461, 2231410527, 2626627137,
  831482227, 3620846965, 4265339591, 3398258153, 2841114459, 3774270365, 159949615, 2167958161, 458900035,
  841326277, 1041524887, 4079950905, 4090358315, 966186733, 3099646719, 1189348065, 3319697171, 3432453141,
  3533937255, 287161993, 707514619, 168228413, 2810595023, 527888177, 1833521123, 2363170149, 1818656823,
  2464036057, 238988235, 4003211661, 2515920543, 1242967937, 218596531, 2582035125, 3474594311, 2620751657,
  152271515, 3974852829, 3211573871, 1663484881, 801516931, 2884561925, 2713413591, 1445502329, 4210507115,
  3284782125, 2861023807, 3024989217, 3211938387, 1550365013, 1049061799, 1056739273, 192345147, 994851709,
  4179885583, 2221926513, 3577273123, 1980304037, 2197495671, 2050381337, 2036309771, 1959247565, 945712607,
  1739749569, 2307317747, 1153759221, 2681440583, 547025001, 1790852571, 986797597, 2962493871, 2407161105,
  3288946883, 3855710533,
]);

const SEEDS_B = new Uint32Array([
  1468258941, 1983402423, 3773030145, 2166013147, 448629189, 3792365631, 3804372681, 2273228771, 3803521549,
  2801291207, 309352337, 27923435, 4163355477, 3243944015, 1793960281, 1367929075, 3681979805, 3637514711,
  1729967137, 915107579, 958832869, 2830806111, 4266006505, 2116398595, 1851858221, 2025887719, 814970033,
  3293564427, 2641568373, 2773218415, 596929145, 1141239571, 1380831421, 940237303, 3468433729, 3083350299,
  3070642181, 2423226495, 937533705, 1243264035, 1482008653, 472903687, 1069556177, 2516949035, 2048463253,
  533090447, 4269194137, 3079994675, 4224820189, 2398142999, 2953350753, 1817772859, 3441721125, 4113654943,
  819771945, 1139132995, 4066034541, 1850628135, 171859697, 3763565131, 417435829, 2932980911, 249339065,
  1186863955, 3150579453, 478786103, 2269811585, 1069933915, 3628680773, 4144519359, 4001325897, 3356422243,
  842559117, 2418266183, 1045834769, 2428591211, 680828885, 2490775759, 3423473113, 2416527731, 436140573,
  1675473495, 3033147553, 2711017339, 1497144677, 2046581983, 3658587241, 924722819, 2981538221, 3870840935,
  1850706225, 416765579, 2079997685, 3602629871, 290655993, 905873299, 1110998333, 737460855, 2093960641,
  2236864923, 4106650757, 638939391, 3235603849, 4120603811, 2929554637, 454291591, 275936849, 1847419051,
  165309973, 1068130575, 502505497, 3743798707, 71209053, 2144789143, 128058081, 1652878267, 1940847525,
  1734055199, 3559177897, 1812906691, 179621869, 440309927, 2131161969, 169573067, 3976015157, 1565134127,
  2503459129, 906441683,
]);

function fnv32(s: string): number {
  let h = 2166136261;
  for (let i = 0; i < s.length; i += 1) {
    h ^= s.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h >>> 0;
}

export function computeNormContentHash(content: string): string {
  const normalized = content.toLowerCase().replace(/\s+/g, " ").trim().replace(/[^\w\s]/g, "");
  return createHash("sha256").update(normalized).digest("hex");
}

export function computeMinhashSig(text: string, numHashes = NUM_HASHES): Uint32Array {
  const chars = text.toLowerCase().replace(/\s+/g, "");
  const ngrams: string[] = [];
  for (let i = 0; i <= chars.length - 5; i += 1) {
    ngrams.push(chars.slice(i, i + 5));
  }
  if (ngrams.length < 3) {
    ngrams.push(text.slice(0, 40) || "empty");
  }

  const sig = new Uint32Array(numHashes).fill(0xffffffff);
  for (const ngram of ngrams) {
    const base = fnv32(ngram);
    for (let i = 0; i < numHashes; i += 1) {
      const h = (Math.imul(base, SEEDS_A[i] ?? 1) + (SEEDS_B[i] ?? 1)) >>> 0;
      if (h < sig[i]) {
        sig[i] = h;
      }
    }
  }
  return sig;
}

export function minhashJaccard(a: Uint32Array, b: Uint32Array): number {
  const size = Math.min(a.length, b.length);
  if (size === 0) {
    return 0;
  }

  let matches = 0;
  for (let i = 0; i < size; i += 1) {
    if (a[i] === b[i]) {
      matches += 1;
    }
  }
  return matches / size;
}

export function minhashSigToBuffer(sig: Uint32Array): Buffer {
  return Buffer.from(sig.buffer);
}

export function bufferToMinhashSig(buf: Buffer | Uint8Array): Uint32Array {
  return new Uint32Array(buf.buffer, buf.byteOffset, NUM_HASHES);
}
